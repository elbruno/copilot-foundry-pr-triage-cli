# Plan: Update README & Refactor to Microsoft Agent Framework

**Date:** February 11, 2026, 09:55  
**Status:** Approved  
**Scope:** Full refactoring with streaming support

---

## Summary

The repository claims to use Microsoft Agent Framework but actually uses raw HTTP calls. This plan delivers:

1. Updated README with correct paths, new repo URL, and educational content for visitors
2. New `.github/copilot-instructions.md` with project rules
3. Full refactoring of both agents to properly use Microsoft Agent Framework:
   - `GitHubCopilotAgent` via `Microsoft.Agents.AI.GitHub.Copilot`
   - `ChatClientAgent` via `Microsoft.Agents.AI`
4. Streaming response support in the TUI
5. Educational documentation structure

Legacy HTTP code will be fully replaced for cleaner educational value.

---

## Phase 1: Documentation Updates

### 1. Fix README.md project paths and repo URL

- Change all `src/RepoTriage.Cli` → `RepoTriage.Cli`
- Update repository URL to `https://github.com/elbruno/copilot-foundry-pr-triage-cli`
- Add architecture overview showing two-agent design:
  - **GitHub Copilot Agent**: PR context fetching, comment drafting (uses `Microsoft.Agents.AI.GitHub.Copilot`)
  - **Foundry Local Agent**: Summarization, risk analysis, checklist (uses `ChatClientAgent` with `IChatClient`)
- Add "Learning Path" section explaining the repo's educational value
- Add links to Microsoft Agent Framework documentation

### 2. Create `.github/copilot-instructions.md` with rules

- All documentation must be in `docs/` folder (except README.md, LICENSE, and root code files)
- All plans must be saved in `docs/plans/` with format `plan_YYMMDD_HHMM.md`
- Agents must implement `AIAgent` pattern from Microsoft Agent Framework
- Use `IChatClient` abstraction for any LLM backend
- Prefer streaming responses for user-facing operations
- Follow existing Spectre.Console UI patterns

### 3. Create `docs/architecture.md`

- Sequence diagram of 5 workflow steps (FetchContext → Summarize → IdentifyRisks → GenerateChecklist → DraftComment)
- Agent responsibility matrix
- Data flow between agents

### 4. Create `docs/getting-started.md`

- Prerequisites installation (Foundry Local, GitHub Copilot CLI)
- Authentication steps
- Running the sample end-to-end

### 5. Create learning modules in `docs/learning/`

- `docs/learning/01-ichatclient-basics.md` - Microsoft.Extensions.AI fundamentals
- `docs/learning/02-aiagent-patterns.md` - ChatClientAgent and GitHubCopilotAgent patterns
- `docs/learning/03-multi-agent-orchestration.md` - How TriageWorkflow coordinates agents

---

## Phase 2: NuGet Package Updates

### 6. Update `RepoTriage.Cli.csproj`

- Add `Microsoft.Agents.AI --prerelease`
- Add `Microsoft.Agents.AI.GitHub.Copilot --prerelease`
- Add `Microsoft.Extensions.AI.OpenAI` (for Foundry Local's OpenAI-compatible endpoint)
- Remove unused `Spectre.Console.Cli` (arg parsing is manual)

---

## Phase 3: Copilot Agent Refactoring

### 7. Refactor `ICopilotAgentClient.cs`

- Change return types to support `AgentResponse` and streaming via `IAsyncEnumerable<AgentResponseUpdate>`
- Add session management for multi-turn conversation context

### 8. Refactor `CopilotAgentClient.cs` to use `GitHubCopilotAgent`

- Remove raw `HttpClient` GitHub REST API calls
- Create `CopilotClient` → `StartAsync()` → `AsAIAgent()`
- Define `AIFunction` tools:
  - `GetPullRequest(owner, repo, prNumber)` - Fetch PR metadata
  - `GetPullRequestDiff(owner, repo, prNumber)` - Get diff content
  - `DraftReviewComment(summary, risks, checklist)` - Format markdown
- Implement streaming via `agent.RunStreamingAsync()`
- Add session management for context retention

---

## Phase 4: Foundry Local Agent Refactoring

### 9. Refactor `IFoundryAgentClient.cs`

- Update signatures to return `AgentResponse` and support `IAsyncEnumerable<AgentResponseUpdate>`

### 10. Refactor `FoundryAgentClient.cs` to use `ChatClientAgent`

- Remove raw `HttpClient` calls to `/v1/chat/completions`
- Create `IChatClient` using OpenAI-compatible client pointing to Foundry Local (`http://localhost:5272`)
- Create `ChatClientAgent` with appropriate instructions for each task type
- Implement streaming via `agent.RunStreamingAsync()`

---

## Phase 5: Workflow & UI Updates

### 11. Update `TriageWorkflow.cs`

- Add error handling with retry logic for LLM calls
- Support streaming progress updates to UI
- Add `ILogger` for diagnostics

### 12. Update `ConsoleUi.cs`

- Implement streaming token display using Spectre.Console live rendering
- Show tokens as they arrive from `RunStreamingAsync()`

### 13. Update `Program.cs`

- Add proper DI using `IServiceCollection`
- Register agents with appropriate lifetimes
- Add configuration for switching between demo mode and live mode

---

## Phase 6: Code Quality

### 14. Add inline educational comments

In all agent files explaining:

- Why `IChatClient` abstraction enables swappable backends
- How `AIAgent.RunAsync()` differs from raw HTTP completion calls
- Tool/function calling patterns
- Session management for multi-turn conversations

### 15. Update mock data

In `CopilotAgentClient.MockData` to align with `docs/sample.diff.patch`

---

## Verification Checklist

| Check | Command/Action |
|-------|----------------|
| Build succeeds | `dotnet build RepoTriage.Cli/RepoTriage.Cli.csproj` |
| README paths correct | Verify `RepoTriage.Cli` (not `src/RepoTriage.Cli`) |
| Copilot instructions exist | Verify `.github/copilot-instructions.md` present |
| Agents use Agent Framework | No `HttpClient` calls for LLM operations |
| Streaming works | Run app and observe token-by-token output |
| Demo mode works | Run `dotnet run -- --demo` without Foundry Local |
| Docs in correct location | All docs in `docs/` except README, LICENSE |

---

## Key Technical Patterns (Reference)

### GitHub Copilot Agent Pattern

```csharp
await using CopilotClient copilotClient = new();
await copilotClient.StartAsync();

AIAgent agent = copilotClient.AsAIAgent(
    tools: [fetchPrTool, draftCommentTool],
    instructions: "You are a PR triage assistant...");

await foreach (var update in agent.RunStreamingAsync(prompt))
{
    Console.Write(update);
}
```

### ChatClientAgent Pattern (Foundry Local)

```csharp
// IChatClient pointing to Foundry Local's OpenAI-compatible endpoint
IChatClient chatClient = new OpenAIClient(
    new Uri("http://localhost:5272/v1"),
    new ApiKeyCredential("not-needed"));

AIAgent agent = new ChatClientAgent(
    chatClient,
    instructions: "You analyze code diffs for risks...",
    name: "RiskAnalyzer");

await foreach (var update in agent.RunStreamingAsync(diffContent))
{
    yield return update;
}
```

---

## References

- [Microsoft Agent Framework - GitHub Copilot Agents](https://learn.microsoft.com/en-us/agent-framework/user-guide/agents/agent-types/github-copilot-agent?pivots=programming-language-csharp)
- [Microsoft Agent Framework - Chat Client Agent](https://learn.microsoft.com/en-us/agent-framework/user-guide/agents/agent-types/chat-client-agent?pivots=programming-language-csharp)
- [Building GitHub Copilot Agents in C# with Microsoft Agent Framework](https://elbruno.com/2026/02/09/building-github-copilot-agents-in-c-with-microsoft-agent-framework/)
