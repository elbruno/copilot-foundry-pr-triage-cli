# Plan: Interactive Model & Timeout Selection Menu

**Created:** February 11, 2026

## Summary

Add an interactive startup menu using Spectre.Console's `SelectionPrompt` that lets users choose a Foundry Local model and configure timeout before running the triage workflow. This addresses the issue of `phi-4` being too slow by offering smaller alternatives like `phi-3.5-mini`.

## Problem

The default `phi-4` model takes a long time to process (300+ seconds), causing timeouts. Users need an easy way to select smaller, faster models without editing configuration files.

## Steps

### 1. Create `StartupMenu.cs` in `Ui/`

Add a static class with methods:

- `SelectModel()` - Returns selected model string using `SelectionPrompt<string>` with choices:
  - `phi-3.5-mini` (recommended for speed)
  - `phi-4`
  - `Phi-4-trtrtx-gpu:1`
  - Custom option (prompts for text input)
- `SelectTimeout()` - Returns timeout in seconds using `SelectionPrompt<int>` with choices: 60, 120, 300 (default), 600, 900
- `ShouldShowMenu()` - Check if `--no-menu` flag is present (allows skipping menu for automation)

### 2. Update `Program.cs`

Add argument parsing:

- Add `--no-menu` flag to skip interactive selection
- Add `--model <name>` argument for CLI-based model selection
- When no `--model` or `--timeout` args provided AND `--no-menu` not set, call `StartupMenu` methods
- Pass selected model/timeout to `FoundryAgentClient` constructor

### 3. Update `FoundryAgentClient.cs`

Add model override parameter:

- Add `string? modelOverride` parameter to constructor
- Use `modelOverride ?? config["FOUNDRY_LOCAL_MODEL"] ?? "phi-4"` for model selection

### 4. Update Usage Message

Document new options in help text:

- Add `--model <name>` to specify model directly
- Add `--no-menu` to skip interactive selection

## Verification

- Run `dotnet run -- --pr <url>` → Should show interactive menu
- Run `dotnet run -- --pr <url> --no-menu` → Should use defaults without menu
- Run `dotnet run -- --pr <url> --model phi-3.5-mini --timeout 120` → Should skip menu and use provided values

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Use `phi-3.5-mini` as recommended | Faster than `phi-4`, suitable for most PR triage tasks |
| Menu appears only when args incomplete | Preserves scriptability for CI/CD pipelines |
| Keep env var support as fallback | Allows configuration in containerized/automated environments |
| Add `--no-menu` flag | Ensures CLI remains automation-friendly |

## Files to Modify

| File | Changes |
|------|---------|
| `RepoTriage.Cli/Ui/StartupMenu.cs` | New file - interactive menu logic |
| `RepoTriage.Cli/Program.cs` | Add argument parsing, integrate menu |
| `RepoTriage.Cli/Agents/FoundryAgentClient.cs` | Add model override parameter |

## Available Models (from Foundry Local)

Discovered via `foundry model list`:

- `phi-3.5-mini` - Smaller, faster
- `phi-4` - Current default, larger
- `Phi-4-trtrtx-gpu:1` - GPU-optimized variant

## Error Handling Pattern

Agents in this project follow these error handling conventions:

### Agent Lifecycle

```csharp
// Use IAsyncDisposable with await using for proper cleanup
await using var copilotAgent = new CopilotAgentClient(token, mock);
await using var foundryAgent = new FoundryAgentClient(config, mock, timeoutSeconds);

// Always initialize before use
await copilotAgent.InitializeAsync(ct);
await foundryAgent.InitializeAsync(ct);
```

### Workflow Error Handling

```csharp
try {
    var result = await workflow.RunAsync(input, progress, ct);
    ConsoleUi.RenderResult(result);
    return 0;
} catch (Exception ex) {
    ConsoleUi.RenderError(ex.Message);  // Friendly error panel
    return 1;
}
```

### LLM Retry Logic

Use exponential backoff for transient failures:

```csharp
private async Task<T> RetryAsync<T>(Func<Task<T>> operation, string name, int maxRetries = 3, CancellationToken ct = default)
{
    for (int attempt = 1; attempt <= maxRetries; attempt++)
    {
        try { return await operation(); }
        catch when (attempt < maxRetries && !ct.IsCancellationRequested)
        {
            var delay = TimeSpan.FromSeconds(Math.Pow(2, attempt)); // 2s, 4s, 8s
            await Task.Delay(delay, ct);
        }
    }
    return await operation(); // Final attempt throws on failure
}
```

### User-Facing Errors

- Use `ConsoleUi.RenderError(message)` for friendly error display
- Return exit code `1` on failure, `0` on success
- Escape user content with `Markup.Escape()` before rendering

## References

- [Spectre.Console SelectionPrompt](https://spectreconsole.net/prompts/selection)
- [Foundry Local Documentation](https://www.foundrylocal.ai/)
